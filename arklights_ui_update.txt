FILENAME:/ui/index.html:<!DOCTYPE html>
<html>
<head>
    <title>ArkLights PEV Control OTA</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="/ui/styles.css">
</head>
<body>
    <div class="container">
        <h1>ArkLights PEV Control v8.0 OTA - Test</h1>
        <div style="text-align: center; margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">
            <strong>Firmware Version:</strong> v8.0 OTA | <strong>Build Date:</strong> <span id="buildDate">Loading...</span>
        </div>
        
        <div class="section">
            <h2>Presets</h2>
            <button class="preset-btn" onclick="setPreset(0)">Standard</button>
            <button class="preset-btn" onclick="setPreset(1)">Night</button>
            <button class="preset-btn" onclick="setPreset(2)">Party</button>
            <button class="preset-btn" onclick="setPreset(3)">Stealth</button>
        </div>
        
        <div class="section">
            <h2>Brightness</h2>
            <div class="control-group">
                <label>Global Brightness: <span id="brightnessValue">128</span></label>
                <input type="range" id="brightness" min="0" max="255" value="128" onchange="setBrightness(this.value)">
            </div>
        </div>
        
        <div class="section">
            <h2>Effect Speed</h2>
            <div class="control-group">
                <label>Effect Speed: <span id="speedValue">64</span></label>
                <input type="range" id="effectSpeed" min="0" max="255" value="64" onchange="setEffectSpeed(this.value)">
                <small>Higher values = faster effects</small>
            </div>
        </div>
        
        <div class="section">
            <h2>Startup Sequence</h2>
            <div class="control-group">
                <label>Startup Animation:</label>
                <select id="startupSequence" onchange="setStartupSequence(this.value)">
                    <option value="0">None</option>
                    <option value="1">Power On</option>
                    <option value="2">Scanner</option>
                    <option value="3">Wave</option>
                    <option value="4">Race</option>
                    <option value="5">Custom</option>
                </select>
                <small>Animation shown when device powers on</small>
            </div>
            <div class="control-group">
                <label>Duration: <span id="startupDurationValue">3000</span>ms</label>
                <input type="range" id="startupDuration" min="1000" max="10000" value="3000" onchange="setStartupDuration(this.value)">
                <small>How long the startup sequence lasts</small>
            </div>
            <div class="control-group">
                <button onclick="testStartupSequence()" style="background: #ff9800;">Test Startup Sequence</button>
                <small>Preview the current startup animation</small>
            </div>
        </div>
        
        <div class="section">
            <h2>üéØ Motion Control</h2>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="motionEnabled" onchange="setMotionEnabled(this.checked)">
                    Enable Motion Control
                </label>
                <small>Master switch for all motion features</small>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="blinkerEnabled" onchange="setBlinkerEnabled(this.checked)">
                    Auto Blinkers
                </label>
                <small>Automatic turn signals based on lean angle</small>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="parkModeEnabled" onchange="setParkModeEnabled(this.checked)">
                    Park Mode
                </label>
                <small>Special effects when stationary and tilted</small>
            </div>
            
            <div class="control-group">
                <label>
                    <input type="checkbox" id="impactDetectionEnabled" onchange="setImpactDetectionEnabled(this.checked)">
                    Impact Detection
                </label>
                <small>Flash lights on sudden acceleration changes</small>
            </div>
            
            <div class="control-group">
                <label>Motion Sensitivity: <span id="motionSensitivityValue">1.0</span></label>
                <input type="range" id="motionSensitivity" min="0.5" max="2.0" step="0.1" 
                       oninput="setMotionSensitivity(this.value)">
                <small>Higher values = more sensitive to motion</small>
            </div>
            
            <div class="control-group">
                <label>Blinker Delay: <span id="blinkerDelayValue">300</span>ms</label>
                <input type="range" id="blinkerDelay" min="100" max="1000" step="50" 
                       oninput="setBlinkerDelay(this.value)">
                <small>Delay before blinker activates after turn detected</small>
            </div>
            
            <div class="control-group">
                <label>Blinker Timeout: <span id="blinkerTimeoutValue">2000</span>ms</label>
                <input type="range" id="blinkerTimeout" min="1000" max="5000" step="100" 
                       oninput="setBlinkerTimeout(this.value)">
                <small>How long blinker stays on after turn ends</small>
            </div>
            
            <div class="control-group">
                <label>Park Stationary Time: <span id="parkStationaryTimeValue">2000</span>ms</label>
                <input type="range" id="parkStationaryTime" min="1000" max="10000" step="500" 
                       oninput="setParkStationaryTime(this.value)">
                <small>How long device must be stationary before park mode activates</small>
            </div>
            
            <div class="control-group">
                <label>Accel Noise Threshold: <span id="parkAccelNoiseThresholdValue">0.1</span>G</label>
                <input type="range" id="parkAccelNoiseThreshold" min="0.05" max="0.5" step="0.01" 
                       oninput="setParkAccelNoiseThreshold(this.value)">
                <small>Maximum acceleration noise to consider device stationary</small>
            </div>
            
            <div class="control-group">
                <label>Gyro Noise Threshold: <span id="parkGyroNoiseThresholdValue">0.5</span>¬∞/s</label>
                <input type="range" id="parkGyroNoiseThreshold" min="0.1" max="2.0" step="0.1" 
                       oninput="setParkGyroNoiseThreshold(this.value)">
                <small>Maximum gyro noise to consider device stationary</small>
            </div>
            
            <div class="control-group">
                <label>Impact Threshold: <span id="impactThresholdValue">3</span>G</label>
                <input type="range" id="impactThreshold" min="1" max="10" step="0.5" 
                       oninput="setImpactThreshold(this.value)">
                <small>G-force threshold for impact detection</small>
            </div>
            
            <!-- Calibration Section -->
            <div class="calibration-section" style="margin-top: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
                <h3>üìê Calibration</h3>
                <div id="calibrationStatus" class="calibration-status">
                    Status: <span id="calibrationStatusText">Not calibrated</span>
                </div>
                
                <div id="calibrationProgress" class="calibration-progress" style="display: none;">
                    <div class="progress-bar" style="width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden;">
                        <div id="calibrationProgressBar" class="progress-fill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s;"></div>
                    </div>
                    <div id="calibrationStepText" style="margin-top: 10px; font-weight: bold;">Step 1: Hold device LEVEL</div>
                </div>
                
                <div class="calibration-controls" style="margin-top: 15px;">
                    <button onclick="startCalibration()" id="startCalibrationBtn" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px;">Start Calibration</button>
                    <button onclick="nextCalibrationStep()" id="nextCalibrationBtn" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin-right: 10px; display: none;">Next Step</button>
                    <button onclick="resetCalibration()" id="resetCalibrationBtn" style="background: #f44336; color: white; padding: 10px 20px; border: none; border-radius: 5px;">Reset Calibration</button>
                </div>
            </div>
            
            <!-- Motion Status -->
            <div class="motion-status" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                <h3>üìä Motion Status</h3>
                <div id="motionStatus">
                    <div>Blinker: <span id="blinkerStatus" style="font-weight: bold;">Inactive</span></div>
                    <div>Park Mode: <span id="parkModeStatus" style="font-weight: bold;">Inactive</span></div>
                    <div>Calibration: <span id="calibrationStatusDisplay" style="font-weight: bold;">Not calibrated</span></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>üÖøÔ∏è Park Mode Settings</h2>
            <div class="control-group">
                <label>Park Effect:</label>
                <select id="parkEffect" onchange="setParkEffect(this.value)">
                    <option value="0">Solid</option>
                    <option value="1">Breath</option>
                    <option value="2">Rainbow</option>
                    <option value="3">Chase</option>
                    <option value="4">Blink Rainbow</option>
                    <option value="5">Twinkle</option>
                    <option value="6">Fire</option>
                    <option value="7">Meteor</option>
                    <option value="8">Wave</option>
                    <option value="9">Comet</option>
                    <option value="10">Candle</option>
                    <option value="11">Static Rainbow</option>
                    <option value="12">Knight Rider</option>
                    <option value="13">Police</option>
                    <option value="14">Strobe</option>
                    <option value="15">Larson Scanner</option>
                    <option value="16">Color Wipe</option>
                    <option value="17">Theater Chase</option>
                    <option value="18">Running Lights</option>
                    <option value="19">Color Sweep</option>
                </select>
                <small>Effect to display when in park mode</small>
            </div>
            
            <div class="control-group">
                <label>Park Effect Speed: <span id="parkEffectSpeedValue">64</span></label>
                <input type="range" id="parkEffectSpeed" min="0" max="255" value="64" oninput="setParkEffectSpeed(this.value)">
                <small>Speed of the park mode effect</small>
            </div>
            
            <div class="control-group">
                <label>Park Brightness: <span id="parkBrightnessValue">128</span></label>
                <input type="range" id="parkBrightness" min="0" max="255" value="128" oninput="setParkBrightness(this.value)">
                <small>Brightness level when in park mode</small>
            </div>
            
            <div class="control-group">
                <label>Park Headlight Color:</label>
                <input type="color" id="parkHeadlightColor" value="#0000ff" onchange="setParkHeadlightColor(this.value)">
                <small>Headlight color when in park mode</small>
            </div>
            
            <div class="control-group">
                <label>Park Taillight Color:</label>
                <input type="color" id="parkTaillightColor" value="#0000ff" onchange="setParkTaillightColor(this.value)">
                <small>Taillight color when in park mode</small>
            </div>
            
            <div class="control-group">
                <button onclick="testParkMode()" style="background: #ff9800;">Test Park Mode</button>
                <small>Preview the current park mode settings</small>
            </div>
        </div>
        
                <div class="section">
                    <h2>OTA Updates</h2>
                    <div class="control-group">
                        <button onclick="window.location.href='/updateui'" style="background: #2196F3; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 5px;">
                            üé® Update UI Files
                        </button>
                        <small>Update web interface without firmware changes</small>
                    </div>
            
            <div class="control-group">
                <small>Firmware updates are always enabled</small>
            </div>
            
            <div class="control-group">
                <label>Firmware File:</label>
                <input type="file" id="otaFileInput" accept=".bin" onchange="handleFileSelect(this)">
                <small>Select firmware binary file (.bin)</small>
            </div>
            
            <div class="control-group">
                <button onclick="startOTAUpdate()" id="startOTAButton" style="background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px;" disabled>
                    Upload & Install
                </button>
                <small>Upload and install firmware file</small>
            </div>
            
            <!-- OTA Progress -->
            <div id="otaProgress" class="ota-progress" style="margin-top: 20px; padding: 15px; background: #f0f0f0; border-radius: 8px; display: none;">
                <h3>üì• Update Progress</h3>
                <div class="progress-bar" style="width: 100%; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden;">
                    <div id="otaProgressBar" class="progress-fill" style="height: 100%; background: #4CAF50; width: 0%; transition: width 0.3s;"></div>
                </div>
                <div id="otaProgressText" style="margin-top: 10px; font-weight: bold;">Preparing update...</div>
                <div id="otaStatusText" style="margin-top: 5px; color: #666;">Status: Ready</div>
            </div>
            
            <!-- OTA Status -->
            <div class="ota-status" style="margin-top: 20px; padding: 15px; background: #e8f5e8; border-radius: 8px;">
                <h3>üìä Update Status</h3>
                <div id="otaStatus">
                    <div>Status: <span id="otaStatusDisplay" style="font-weight: bold;">Ready</span></div>
                    <div>Progress: <span id="otaProgressDisplay" style="font-weight: bold;">0%</span></div>
                    <div>Error: <span id="otaErrorDisplay" style="font-weight: bold; color: #d32f2f;">None</span></div>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>WiFi Configuration</h2>
            <div class="control-group">
                <label>Access Point Name:</label>
                <input type="text" id="apName" value="ARKLIGHTS-AP" maxlength="32" onchange="setAPName(this.value)">
                <small>WiFi network name (max 32 characters)</small>
            </div>
            <div class="control-group">
                <label>Password:</label>
                <input type="password" id="apPassword" value="float420" maxlength="63" onchange="setAPPassword(this.value)">
                <small>WiFi password (8-63 characters)</small>
            </div>
            <div class="control-group">
                <button onclick="applyWiFiConfig()" class="btn btn-primary">Apply WiFi Settings</button>
                <small>‚ö†Ô∏è Changes require restart to take effect</small>
            </div>
        </div>
        
        <div class="section">
            <h2>Headlight</h2>
            <div class="control-group">
                <label>Color:</label>
                <input type="color" id="headlightColor" value="#ffffff" onchange="setHeadlightColor(this.value)">
            </div>
            <div class="control-group">
                <label>Effect:</label>
                <select id="headlightEffect" onchange="setHeadlightEffect(this.value)">
                    <option value="0">Solid</option>
                    <option value="1">Breath</option>
                    <option value="2">Rainbow</option>
                    <option value="3">Chase</option>
                    <option value="4">Blink Rainbow</option>
                    <option value="5">Twinkle</option>
                    <option value="6">Fire</option>
                    <option value="7">Meteor</option>
                    <option value="8">Wave</option>
                    <option value="9">Comet</option>
                    <option value="10">Candle</option>
                    <option value="11">Static Rainbow</option>
                    <option value="12">Knight Rider</option>
                    <option value="13">Police</option>
                    <option value="14">Strobe</option>
                    <option value="15">Larson Scanner</option>
                    <option value="16">Color Wipe</option>
                    <option value="17">Theater Chase</option>
                    <option value="18">Running Lights</option>
                    <option value="19">Color Sweep</option>
                </select>
            </div>
        </div>
        
        <div class="section">
            <h2>Taillight</h2>
            <div class="control-group">
                <label>Color:</label>
                <input type="color" id="taillightColor" value="#ff0000" onchange="setTaillightColor(this.value)">
            </div>
            <div class="control-group">
                <label>Effect:</label>
                <select id="taillightEffect" onchange="setTaillightEffect(this.value)">
                    <option value="0">Solid</option>
                    <option value="1">Breath</option>
                    <option value="2">Rainbow</option>
                    <option value="3">Chase</option>
                    <option value="4">Blink Rainbow</option>
                    <option value="5">Twinkle</option>
                    <option value="6">Fire</option>
                    <option value="7">Meteor</option>
                    <option value="8">Wave</option>
                    <option value="9">Comet</option>
                    <option value="10">Candle</option>
                    <option value="11">Static Rainbow</option>
                    <option value="12">Knight Rider</option>
                    <option value="13">Police</option>
                    <option value="14">Strobe</option>
                    <option value="15">Larson Scanner</option>
                    <option value="16">Color Wipe</option>
                    <option value="17">Theater Chase</option>
                    <option value="18">Running Lights</option>
                    <option value="19">Color Sweep</option>
                </select>
            </div>
        </div>
        
        <div class="section">
            <h2>LED Configuration</h2>
            <div class="control-group">
                <label>Headlight LED Count:</label>
                <input type="number" id="headlightLedCount" min="1" max="200" value="20" onchange="updateLEDConfig()">
            </div>
            <div class="control-group">
                <label>Taillight LED Count:</label>
                <input type="number" id="taillightLedCount" min="1" max="200" value="20" onchange="updateLEDConfig()">
            </div>
            <div class="control-group">
                <label>Headlight LED Type:</label>
                <select id="headlightLedType" onchange="updateLEDConfig()">
                    <option value="0">SK6812 (RGBW)</option>
                    <option value="1">WS2812B (RGB)</option>
                    <option value="2">APA102 (RGB)</option>
                    <option value="3">LPD8806 (RGB)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Taillight LED Type:</label>
                <select id="taillightLedType" onchange="updateLEDConfig()">
                    <option value="0">SK6812 (RGBW)</option>
                    <option value="1">WS2812B (RGB)</option>
                    <option value="2">APA102 (RGB)</option>
                    <option value="3">LPD8806 (RGB)</option>
                </select>
            </div>
            <div class="control-group">
                <label>Headlight Color Order:</label>
                <select id="headlightColorOrder" onchange="updateLEDConfig()">
                    <option value="0">GRB</option>
                    <option value="1">RGB</option>
                    <option value="2">BGR</option>
                </select>
            </div>
            <div class="control-group">
                <label>Taillight Color Order:</label>
                <select id="taillightColorOrder" onchange="updateLEDConfig()">
                    <option value="0">GRB</option>
                    <option value="1">RGB</option>
                    <option value="2">BGR</option>
                </select>
            </div>
            <div class="control-group">
                <button onclick="testLEDs()" style="background: #ff9800;">Test LEDs (Red‚ÜíGreen‚ÜíBlue‚ÜíWhite)</button>
                <button onclick="saveLEDConfig()" style="background: #4CAF50;">Save Configuration</button>
            </div>
        </div>
        
        <div class="section">
            <h2>Status</h2>
            <div class="status" id="status">Loading...</div>
            <button onclick="updateStatus()">Refresh Status</button>
        </div>
    </div>
    
    <script src="/ui/script.js"></script>
</body>
</html>
:ENDFILE
FILENAME:/ui/styles.css:body { 
    font-family: Arial, sans-serif; 
    margin: 20px; 
    background: #1a1a1a; 
    color: #fff; 
}

.container { 
    max-width: 600px; 
    margin: 0 auto; 
}

.section { 
    background: #2a2a2a; 
    padding: 20px; 
    margin: 10px 0; 
    border-radius: 8px; 
}

.preset-btn { 
    background: #4CAF50; 
    color: white; 
    padding: 10px 20px; 
    margin: 5px; 
    border: none; 
    border-radius: 4px; 
    cursor: pointer; 
}

.preset-btn:hover { 
    background: #45a049; 
}

.control-group { 
    margin: 15px 0; 
}

label { 
    display: block; 
    margin-bottom: 5px; 
}

input[type="range"] { 
    width: 100%; 
}

input[type="color"] { 
    width: 50px; 
    height: 30px; 
}

select { 
    padding: 8px; 
    border-radius: 4px; 
    background: #333; 
    color: #fff; 
    border: 1px solid #555; 
}

.status { 
    background: #333; 
    padding: 10px; 
    border-radius: 4px; 
    margin: 10px 0; 
}

h1 { 
    color: #4CAF50; 
    text-align: center; 
}

h2 { 
    color: #81C784; 
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    margin: 5px;
}

.btn-primary {
    background: #2196F3;
    color: white;
}

.btn-primary:hover {
    background: #1976D2;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #ddd;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #4CAF50;
    width: 0%;
    transition: width 0.3s;
}

.calibration-section {
    margin-top: 20px;
    padding: 15px;
    background: #f5f5f5;
    border-radius: 8px;
}

.motion-status {
    margin-top: 20px;
    padding: 15px;
    background: #e8f5e8;
    border-radius: 8px;
}

.ota-progress {
    margin-top: 20px;
    padding: 15px;
    background: #f0f0f0;
    border-radius: 8px;
}

.ota-status {
    margin-top: 20px;
    padding: 15px;
    background: #e8f5e8;
    border-radius: 8px;
}
:ENDFILE
FILENAME:/ui/script.js:// ArkLights PEV Control - JavaScript Functions

function setPreset(preset) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ preset: preset })
    }).then(() => updateStatus());
}

function setBrightness(value) {
    document.getElementById('brightnessValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ brightness: parseInt(value) })
    });
}

function setEffectSpeed(value) {
    document.getElementById('speedValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ effectSpeed: parseInt(value) })
    });
}

function setStartupSequence(sequence) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ startup_sequence: parseInt(sequence) })
    });
}

function setStartupDuration(duration) {
    document.getElementById('startupDurationValue').textContent = duration;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ startup_duration: parseInt(duration) })
    });
}

function testStartupSequence() {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ testStartup: true })
    }).then(() => {
        console.log('Startup sequence test started');
    });
}

// Motion Control Functions
function setMotionEnabled(enabled) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ motion_enabled: enabled })
    });
}

function setBlinkerEnabled(enabled) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blinker_enabled: enabled })
    });
}

function setParkModeEnabled(enabled) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_mode_enabled: enabled })
    });
}

function setImpactDetectionEnabled(enabled) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ impact_detection_enabled: enabled })
    });
}

function setMotionSensitivity(value) {
    document.getElementById('motionSensitivityValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ motion_sensitivity: parseFloat(value) })
    });
}

function setBlinkerDelay(value) {
    document.getElementById('blinkerDelayValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blinker_delay: parseInt(value) })
    });
}

function setBlinkerTimeout(value) {
    document.getElementById('blinkerTimeoutValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ blinker_timeout: parseInt(value) })
    });
}

function setParkDetectionAngle(value) {
    document.getElementById('parkDetectionAngleValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_detection_angle: parseInt(value) })
    });
}

function setParkStationaryTime(value) {
    document.getElementById('parkStationaryTimeValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_stationary_time: parseInt(value) })
    });
}

function setParkAccelNoiseThreshold(value) {
    document.getElementById('parkAccelNoiseThresholdValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_accel_noise_threshold: parseFloat(value) })
    });
}

function setParkGyroNoiseThreshold(value) {
    document.getElementById('parkGyroNoiseThresholdValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_gyro_noise_threshold: parseFloat(value) })
    });
}

function setImpactThreshold(value) {
    document.getElementById('impactThresholdValue').textContent = value;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ impact_threshold: parseFloat(value) })
    });
}

// Park Mode Settings Functions
function setParkEffect(effect) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_effect: parseInt(effect) })
    });
}

function setParkEffectSpeed(speed) {
    document.getElementById('parkEffectSpeedValue').textContent = speed;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_effect_speed: parseInt(speed) })
    });
}

function setParkBrightness(brightness) {
    document.getElementById('parkBrightnessValue').textContent = brightness;
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ park_brightness: parseInt(brightness) })
    });
}

function setParkHeadlightColor(color) {
    const rgb = hexToRgb(color);
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            park_headlight_color_r: rgb.r,
            park_headlight_color_g: rgb.g,
            park_headlight_color_b: rgb.b
        })
    });
}

function setParkTaillightColor(color) {
    const rgb = hexToRgb(color);
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            park_taillight_color_r: rgb.r,
            park_taillight_color_g: rgb.g,
            park_taillight_color_b: rgb.b
        })
    });
}

function testParkMode() {
    // Temporarily activate park mode for testing
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ testParkMode: true })
    });
}

// Utility function to convert hex to RGB
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : {r: 0, g: 0, b: 0};
}

// Utility function to convert RGB to hex
function rgbToHex(r, g, b) {
    return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
}

function startCalibration() {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ startCalibration: true })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Calibration started:', data);
        // Show progress UI
        document.getElementById('calibrationProgress').style.display = 'block';
        document.getElementById('startCalibrationBtn').style.display = 'none';
        document.getElementById('nextCalibrationBtn').style.display = 'inline-block';
        document.getElementById('calibrationStatusText').textContent = 'In Progress';
        // Update status to get current calibration state
        updateStatus();
    })
    .catch(error => {
        console.error('Error starting calibration:', error);
    });
}

function nextCalibrationStep() {
    // Disable button temporarily to prevent double-clicks
    const nextBtn = document.getElementById('nextCalibrationBtn');
    nextBtn.disabled = true;
    nextBtn.textContent = 'Capturing...';
    
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ nextCalibrationStep: true })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Next calibration step sent:', data);
        // Re-enable button
        nextBtn.disabled = false;
        nextBtn.textContent = 'Next Step';
        // Add small delay to ensure backend has updated the step
        setTimeout(() => {
            updateStatus();
        }, 100);
    })
    .catch(error => {
        console.error('Error sending next calibration step:', error);
        // Re-enable button on error
        nextBtn.disabled = false;
        nextBtn.textContent = 'Next Step';
    });
}

function resetCalibration() {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ resetCalibration: true })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Calibration reset:', data);
        // Reset UI
        document.getElementById('calibrationProgress').style.display = 'none';
        document.getElementById('startCalibrationBtn').style.display = 'inline-block';
        document.getElementById('nextCalibrationBtn').style.display = 'none';
        document.getElementById('calibrationStatusText').textContent = 'Not calibrated';
        document.getElementById('calibrationProgressBar').style.width = '0%';
        // Update status to get current state
        updateStatus();
    })
    .catch(error => {
        console.error('Error resetting calibration:', error);
    });
}

// OTA Update Functions
function handleFileSelect(input) {
    const file = input.files[0];
    const button = document.getElementById('startOTAButton');
    
    if (file) {
        if (file.name.endsWith('.bin')) {
            button.disabled = false;
            button.textContent = `Upload & Install (${(file.size / 1024 / 1024).toFixed(1)}MB)`;
        } else {
            alert('Please select a .bin file');
            input.value = '';
            button.disabled = true;
            button.textContent = 'Upload & Install';
        }
    } else {
        button.disabled = true;
        button.textContent = 'Upload & Install';
    }
}

function startOTAUpdate() {
    const fileInput = document.getElementById('otaFileInput');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a firmware file first');
        return;
    }
    
    if (!confirm('This will restart the device. Continue?')) {
        return;
    }
    
    // Show progress UI
    document.getElementById('otaProgress').style.display = 'block';
    document.getElementById('startOTAButton').disabled = true;
    document.getElementById('otaProgressText').textContent = 'Uploading file...';
    document.getElementById('otaStatusText').textContent = 'Status: Uploading';
    
    // Upload file
    const formData = new FormData();
    formData.append('firmware', file);
    
    fetch('/api/ota-upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.message && data.message.includes('restarting')) {
                // Update completed successfully
                document.getElementById('otaProgressText').textContent = '‚úÖ Update complete! Device is restarting...';
                document.getElementById('otaStatusText').textContent = 'Status: Complete - Restarting';
                document.getElementById('otaProgressBar').style.width = '100%';
                document.getElementById('otaProgressBar').style.background = '#4CAF50';
                
                // Show success message
                setTimeout(() => {
                    alert('‚úÖ Firmware update completed successfully! The device is restarting with the new firmware.');
                }, 1000);
                
                // Redirect to the page after a delay to see the new firmware
                setTimeout(() => {
                    window.location.reload();
                }, 5000);
            } else {
                document.getElementById('otaProgressText').textContent = 'Installing firmware...';
                document.getElementById('otaStatusText').textContent = 'Status: Installing';
            }
        } else {
            alert('Upload failed: ' + (data.error || 'Unknown error'));
            document.getElementById('otaProgress').style.display = 'none';
            document.getElementById('startOTAButton').disabled = false;
        }
    })
    .catch(error => {
        alert('Upload error: ' + error);
        document.getElementById('otaProgress').style.display = 'none';
        document.getElementById('startOTAButton').disabled = false;
    });
}

function setAPName(name) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apName: name })
    });
}

function setAPPassword(password) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ apPassword: password })
    });
}

function applyWiFiConfig() {
    const name = document.getElementById('apName').value;
    const password = document.getElementById('apPassword').value;
    
    if (name.length < 1 || name.length > 32) {
        alert('AP Name must be 1-32 characters');
        return;
    }
    
    if (password.length < 8 || password.length > 63) {
        alert('Password must be 8-63 characters');
        return;
    }
    
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            apName: name,
            apPassword: password,
            restart: true 
        })
    }).then(() => {
        alert('WiFi settings saved! Device will restart in 3 seconds...');
        setTimeout(() => {
            window.location.reload();
        }, 3000);
    });
}

function setHeadlightColor(color) {
    const hex = color.replace('#', '');
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ headlightColor: hex })
    });
}

function setTaillightColor(color) {
    const hex = color.replace('#', '');
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taillightColor: hex })
    });
}

function setHeadlightEffect(effect) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ headlightEffect: parseInt(effect) })
    });
}

function setTaillightEffect(effect) {
    fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ taillightEffect: parseInt(effect) })
    });
}

function updateStatus() {
    fetch('/api/status')
        .then(response => response.json())
        .then(data => {
            document.getElementById('status').innerHTML = 
                `Preset: ${data.preset}<br>` +
                `Brightness: ${data.brightness}<br>` +
                `Effect Speed: ${data.effectSpeed}<br>` +
                `Startup: ${data.startup_sequence_name} (${data.startup_duration}ms)<br>` +
                `Motion: ${data.motion_enabled ? 'Enabled' : 'Disabled'}<br>` +
                `Blinker: ${data.blinker_active ? (data.blinker_direction > 0 ? 'Right' : 'Left') : 'Inactive'}<br>` +
                `Park Mode: ${data.park_mode_active ? 'Active' : 'Inactive'}<br>` +
                `Calibration: ${data.calibration_complete ? 'Complete' : 'Not calibrated'}<br>` +
                `WiFi AP: ${data.apName}<br>` +
                `Headlight: Effect ${data.headlightEffect}, Color #${data.headlightColor}<br>` +
                `Taillight: Effect ${data.taillightEffect}, Color #${data.taillightColor}<br>` +
                `Headlight Config: ${data.headlightLedCount} LEDs, Type ${data.headlightLedType}, Order ${data.headlightColorOrder}<br>` +
                `Taillight Config: ${data.taillightLedCount} LEDs, Type ${data.taillightLedType}, Order ${data.taillightColorOrder}`;

            // Update UI elements
            // Update elements that exist, with null checks
            const brightnessEl = document.getElementById('brightness');
            if (brightnessEl) brightnessEl.value = data.brightness;
            const brightnessValueEl = document.getElementById('brightnessValue');
            if (brightnessValueEl) brightnessValueEl.textContent = data.brightness;
            
            const effectSpeedEl = document.getElementById('effectSpeed');
            if (effectSpeedEl) effectSpeedEl.value = data.effectSpeed;
            const speedValueEl = document.getElementById('speedValue');
            if (speedValueEl) speedValueEl.textContent = data.effectSpeed;
            
            const startupSequenceEl = document.getElementById('startupSequence');
            if (startupSequenceEl) startupSequenceEl.value = data.startup_sequence;
            
            const startupDurationEl = document.getElementById('startupDuration');
            if (startupDurationEl) startupDurationEl.value = data.startup_duration;
            const startupDurationValueEl = document.getElementById('startupDurationValue');
            if (startupDurationValueEl) startupDurationValueEl.textContent = data.startup_duration;
            
            // Update motion control UI (with null checks)
            const motionEnabledEl = document.getElementById('motionEnabled');
            if (motionEnabledEl) motionEnabledEl.checked = data.motion_enabled;
            const blinkerEnabledEl = document.getElementById('blinkerEnabled');
            if (blinkerEnabledEl) blinkerEnabledEl.checked = data.blinker_enabled;
            const parkModeEnabledEl = document.getElementById('parkModeEnabled');
            if (parkModeEnabledEl) parkModeEnabledEl.checked = data.park_mode_enabled;
            const impactDetectionEnabledEl = document.getElementById('impactDetectionEnabled');
            if (impactDetectionEnabledEl) impactDetectionEnabledEl.checked = data.impact_detection_enabled;
            
            const motionSensitivityEl = document.getElementById('motionSensitivity');
            if (motionSensitivityEl) motionSensitivityEl.value = data.motion_sensitivity;
            const motionSensitivityValueEl = document.getElementById('motionSensitivityValue');
            if (motionSensitivityValueEl) motionSensitivityValueEl.textContent = data.motion_sensitivity;
            
            const blinkerDelayEl = document.getElementById('blinkerDelay');
            if (blinkerDelayEl) blinkerDelayEl.value = data.blinker_delay;
            const blinkerDelayValueEl = document.getElementById('blinkerDelayValue');
            if (blinkerDelayValueEl) blinkerDelayValueEl.textContent = data.blinker_delay;
            
            const blinkerTimeoutEl = document.getElementById('blinkerTimeout');
            if (blinkerTimeoutEl) blinkerTimeoutEl.value = data.blinker_timeout;
            const blinkerTimeoutValueEl = document.getElementById('blinkerTimeoutValue');
            if (blinkerTimeoutValueEl) blinkerTimeoutValueEl.textContent = data.blinker_timeout;
            
            const parkDetectionAngleEl = document.getElementById('parkDetectionAngle');
            if (parkDetectionAngleEl) parkDetectionAngleEl.value = data.park_detection_angle;
            const parkDetectionAngleValueEl = document.getElementById('parkDetectionAngleValue');
            if (parkDetectionAngleValueEl) parkDetectionAngleValueEl.textContent = data.park_detection_angle;
            
            const parkStationaryTimeEl = document.getElementById('parkStationaryTime');
            if (parkStationaryTimeEl) parkStationaryTimeEl.value = data.park_stationary_time;
            const parkStationaryTimeValueEl = document.getElementById('parkStationaryTimeValue');
            if (parkStationaryTimeValueEl) parkStationaryTimeValueEl.textContent = data.park_stationary_time;
            
            const parkAccelNoiseThresholdEl = document.getElementById('parkAccelNoiseThreshold');
            if (parkAccelNoiseThresholdEl) parkAccelNoiseThresholdEl.value = data.park_accel_noise_threshold;
            const parkAccelNoiseThresholdValueEl = document.getElementById('parkAccelNoiseThresholdValue');
            if (parkAccelNoiseThresholdValueEl) parkAccelNoiseThresholdValueEl.textContent = data.park_accel_noise_threshold;
            
            const parkGyroNoiseThresholdEl = document.getElementById('parkGyroNoiseThreshold');
            if (parkGyroNoiseThresholdEl) parkGyroNoiseThresholdEl.value = data.park_gyro_noise_threshold;
            const parkGyroNoiseThresholdValueEl = document.getElementById('parkGyroNoiseThresholdValue');
            if (parkGyroNoiseThresholdValueEl) parkGyroNoiseThresholdValueEl.textContent = data.park_gyro_noise_threshold;
            
            const impactThresholdEl = document.getElementById('impactThreshold');
            if (impactThresholdEl) impactThresholdEl.value = data.impact_threshold;
            const impactThresholdValueEl = document.getElementById('impactThresholdValue');
            if (impactThresholdValueEl) impactThresholdValueEl.textContent = data.impact_threshold;
            
            // Update park mode settings (with null checks)
            const parkEffectEl = document.getElementById('parkEffect');
            if (parkEffectEl) parkEffectEl.value = data.park_effect;
            
            const parkEffectSpeedEl = document.getElementById('parkEffectSpeed');
            if (parkEffectSpeedEl) parkEffectSpeedEl.value = data.park_effect_speed;
            const parkEffectSpeedValueEl = document.getElementById('parkEffectSpeedValue');
            if (parkEffectSpeedValueEl) parkEffectSpeedValueEl.textContent = data.park_effect_speed;
            
            const parkBrightnessEl = document.getElementById('parkBrightness');
            if (parkBrightnessEl) parkBrightnessEl.value = data.park_brightness;
            const parkBrightnessValueEl = document.getElementById('parkBrightnessValue');
            if (parkBrightnessValueEl) parkBrightnessValueEl.textContent = data.park_brightness;
            
            const parkHeadlightColorEl = document.getElementById('parkHeadlightColor');
            if (parkHeadlightColorEl) parkHeadlightColorEl.value = rgbToHex(data.park_headlight_color_r, data.park_headlight_color_g, data.park_headlight_color_b);
            
            const parkTaillightColorEl = document.getElementById('parkTaillightColor');
            if (parkTaillightColorEl) parkTaillightColorEl.value = rgbToHex(data.park_taillight_color_r, data.park_taillight_color_g, data.park_taillight_color_b);
            
            // Update OTA status (with null checks)
            const otaStatusDisplayEl = document.getElementById('otaStatusDisplay');
            if (otaStatusDisplayEl) otaStatusDisplayEl.textContent = data.ota_status;
            const otaProgressDisplayEl = document.getElementById('otaProgressDisplay');
            if (otaProgressDisplayEl) otaProgressDisplayEl.textContent = data.ota_progress + '%';
            const otaErrorDisplayEl = document.getElementById('otaErrorDisplay');
            if (otaErrorDisplayEl) otaErrorDisplayEl.textContent = data.ota_error || 'None';
            
            // Update OTA progress bar (with null checks)
            if (data.ota_in_progress) {
                const otaProgressEl = document.getElementById('otaProgress');
                if (otaProgressEl) otaProgressEl.style.display = 'block';
                const otaProgressBarEl = document.getElementById('otaProgressBar');
                if (otaProgressBarEl) otaProgressBarEl.style.width = data.ota_progress + '%';
                const otaProgressTextEl = document.getElementById('otaProgressText');
                if (otaProgressTextEl) otaProgressTextEl.textContent = `${data.ota_status}... ${data.ota_progress}%`;
                const otaStatusTextEl = document.getElementById('otaStatusText');
                if (otaStatusTextEl) otaStatusTextEl.textContent = `Status: ${data.ota_status}`;
                const startOTAButtonEl = document.getElementById('startOTAButton');
                if (startOTAButtonEl) startOTAButtonEl.disabled = true;
            } else {
                const otaProgressEl = document.getElementById('otaProgress');
                if (otaProgressEl) otaProgressEl.style.display = 'none';
                const startOTAButtonEl = document.getElementById('startOTAButton');
                if (startOTAButtonEl) startOTAButtonEl.disabled = false;
            }
            
            // Update firmware version info (with null checks)
            const buildDateEl = document.getElementById('buildDate');
            if (buildDateEl) buildDateEl.textContent = data.build_date || 'Unknown';
            
            // Update motion status (with null checks)
            const blinkerStatusEl = document.getElementById('blinkerStatus');
            if (blinkerStatusEl) blinkerStatusEl.textContent = data.blinker_active ? 
                (data.blinker_direction > 0 ? 'Right' : 'Left') : 'Inactive';
            const parkModeStatusEl = document.getElementById('parkModeStatus');
            if (parkModeStatusEl) parkModeStatusEl.textContent = data.park_mode_active ? 'Active' : 'Inactive';
            const calibrationStatusDisplayEl = document.getElementById('calibrationStatusDisplay');
            if (calibrationStatusDisplayEl) calibrationStatusDisplayEl.textContent = data.calibration_complete ? 'Complete' : 'Not calibrated';
            
            // Update calibration UI (with null checks)
            if (data.calibration_mode) {
                console.log('Calibration mode active, step:', data.calibration_step, 'complete:', data.calibration_complete);
                
                const calibrationProgressEl = document.getElementById('calibrationProgress');
                if (calibrationProgressEl) calibrationProgressEl.style.display = 'block';
                const startCalibrationBtnEl = document.getElementById('startCalibrationBtn');
                if (startCalibrationBtnEl) startCalibrationBtnEl.style.display = 'none';
                const nextCalibrationBtnEl = document.getElementById('nextCalibrationBtn');
                if (nextCalibrationBtnEl) nextCalibrationBtnEl.style.display = 'inline-block';
                const calibrationStatusTextEl = document.getElementById('calibrationStatusText');
                if (calibrationStatusTextEl) calibrationStatusTextEl.textContent = 'In Progress';
                
                // Update progress bar - calibration_step represents current step (0-4)
                // Progress should show how much is completed
                const currentStep = data.calibration_step; // 0-4
                const progress = ((currentStep + 1) / 5) * 100; // 20%, 40%, 60%, 80%, 100%
                const calibrationProgressBarEl = document.getElementById('calibrationProgressBar');
                if (calibrationProgressBarEl) calibrationProgressBarEl.style.width = progress + '%';
                
                // Update step text - show current step being worked on
                const stepTexts = [
                    'Hold device LEVEL',
                    'Tilt FORWARD', 
                    'Tilt BACKWARD',
                    'Tilt LEFT',
                    'Tilt RIGHT'
                ];
                const currentStepNumber = data.calibration_step + 1; // 1-5
                const stepIndex = Math.min(data.calibration_step, 4); // Ensure we don't go out of bounds
                const stepDescription = stepTexts[stepIndex] || 'Calibrating...';
                
                // Show current step with clear instructions
                const calibrationStepTextEl = document.getElementById('calibrationStepText');
                if (calibrationStepTextEl) calibrationStepTextEl.textContent = `Step ${currentStepNumber}/5: ${stepDescription}`;
                
                console.log('Updated UI - Step:', currentStepNumber, 'Progress:', progress + '%', 'Text:', stepDescription);
                
                // Auto-refresh UI every 2 seconds during calibration
                if (!window.calibrationRefreshInterval) {
                    window.calibrationRefreshInterval = setInterval(updateStatus, 2000);
                }
            } else {
                const calibrationProgressEl = document.getElementById('calibrationProgress');
                if (calibrationProgressEl) calibrationProgressEl.style.display = 'none';
                const startCalibrationBtnEl = document.getElementById('startCalibrationBtn');
                if (startCalibrationBtnEl) startCalibrationBtnEl.style.display = 'inline-block';
                const nextCalibrationBtnEl = document.getElementById('nextCalibrationBtn');
                if (nextCalibrationBtnEl) nextCalibrationBtnEl.style.display = 'none';
                const calibrationStatusTextEl = document.getElementById('calibrationStatusText');
                if (calibrationStatusTextEl) calibrationStatusTextEl.textContent = data.calibration_complete ? 'Complete' : 'Not calibrated';
                
                // Clear auto-refresh when calibration is done
                if (window.calibrationRefreshInterval) {
                    clearInterval(window.calibrationRefreshInterval);
                    window.calibrationRefreshInterval = null;
                }
            }
            
            // Update remaining elements (with null checks)
            const apNameEl = document.getElementById('apName');
            if (apNameEl) apNameEl.value = data.apName;
            const apPasswordEl = document.getElementById('apPassword');
            if (apPasswordEl) apPasswordEl.value = data.apPassword;
            const headlightColorEl = document.getElementById('headlightColor');
            if (headlightColorEl) {
                // Ensure color is in proper #rrggbb format
                let headlightColor = data.headlightColor;
                if (headlightColor.length === 4) {
                    // Convert #rgb to #rrggbb
                    headlightColor = '#' + headlightColor[1] + headlightColor[1] + 
                                   headlightColor[2] + headlightColor[2] + 
                                   headlightColor[3] + headlightColor[3];
                } else if (headlightColor.length === 3) {
                    // Convert rgb to #rrggbb
                    headlightColor = '#' + headlightColor[0] + headlightColor[0] + 
                                   headlightColor[1] + headlightColor[1] + 
                                   headlightColor[2] + headlightColor[2];
                } else if (!headlightColor.startsWith('#')) {
                    headlightColor = '#' + headlightColor;
                }
                headlightColorEl.value = headlightColor;
            }
            const taillightColorEl = document.getElementById('taillightColor');
            if (taillightColorEl) {
                // Ensure color is in proper #rrggbb format
                let taillightColor = data.taillightColor;
                if (taillightColor.length === 4) {
                    // Convert #rgb to #rrggbb
                    taillightColor = '#' + taillightColor[1] + taillightColor[1] + 
                                   taillightColor[2] + taillightColor[2] + 
                                   taillightColor[3] + taillightColor[3];
                } else if (taillightColor.length === 3) {
                    // Convert rgb to #rrggbb
                    taillightColor = '#' + taillightColor[0] + taillightColor[0] + 
                                   taillightColor[1] + taillightColor[1] + 
                                   taillightColor[2] + taillightColor[2];
                } else if (!taillightColor.startsWith('#')) {
                    taillightColor = '#' + taillightColor;
                }
                taillightColorEl.value = taillightColor;
            }
            const headlightEffectEl = document.getElementById('headlightEffect');
            if (headlightEffectEl) headlightEffectEl.value = data.headlightEffect;
            const taillightEffectEl = document.getElementById('taillightEffect');
            if (taillightEffectEl) taillightEffectEl.value = data.taillightEffect;
            
            // Update LED configuration elements (with null checks)
            const headlightLedCountEl = document.getElementById('headlightLedCount');
            if (headlightLedCountEl) headlightLedCountEl.value = data.headlightLedCount;
            const taillightLedCountEl = document.getElementById('taillightLedCount');
            if (taillightLedCountEl) taillightLedCountEl.value = data.taillightLedCount;
            const headlightLedTypeEl = document.getElementById('headlightLedType');
            if (headlightLedTypeEl) headlightLedTypeEl.value = data.headlightLedType;
            const taillightLedTypeEl = document.getElementById('taillightLedType');
            if (taillightLedTypeEl) taillightLedTypeEl.value = data.taillightLedType;
            const headlightColorOrderEl = document.getElementById('headlightColorOrder');
            if (headlightColorOrderEl) headlightColorOrderEl.value = data.headlightColorOrder;
            const taillightColorOrderEl = document.getElementById('taillightColorOrder');
            if (taillightColorOrderEl) taillightColorOrderEl.value = data.taillightColorOrder;
        });
}

function updateLEDConfig() {
    const config = {
        headlightLedCount: parseInt(document.getElementById('headlightLedCount').value),
        taillightLedCount: parseInt(document.getElementById('taillightLedCount').value),
        headlightLedType: parseInt(document.getElementById('headlightLedType').value),
        taillightLedType: parseInt(document.getElementById('taillightLedType').value),
        headlightColorOrder: parseInt(document.getElementById('headlightColorOrder').value),
        taillightColorOrder: parseInt(document.getElementById('taillightColorOrder').value)
    };
    
    fetch('/api/led-config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(config)
    }).then(() => {
        console.log('LED configuration updated');
        updateStatus();
    });
}

function testLEDs() {
    fetch('/api/led-test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    }).then(() => {
        console.log('LED test completed');
    });
}

function saveLEDConfig() {
    updateLEDConfig();
    alert('LED configuration saved!');
}

// Update status on page load
updateStatus();

// Auto-refresh status every 5 seconds
setInterval(updateStatus, 5000);

// Cleanup calibration refresh interval when page is unloaded
window.addEventListener('beforeunload', function() {
    if (window.calibrationRefreshInterval) {
        clearInterval(window.calibrationRefreshInterval);
        window.calibrationRefreshInterval = null;
    }
});
:ENDFILE
