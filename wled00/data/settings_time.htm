<!DOCTYPE html>
<html lang="en">
<head>
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<meta charset="utf-8">
	<title>Time Settings</title>
	<script src="common.js" type="text/javascript"></script>
	<script>
	var el=false;
	var ms=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
	var pJson = {}; // Store presets
	var presetsLoaded = false;

	function S() {
		getLoc();
		loadPresets(); // Load presets first
		loadJS(getURL('/settings/s.js?p=5'), false, ()=>{BTa();}, ()=>{
			updLatLon();
			Cs();
			FC();
		});	// If we set async false, file is loaded and executed, then next statement is processed
		if (loc) d.Sf.action = getURL('/settings/time');
	}

	function loadPresets() {
		fetch(getURL('/presets.json'), {
			method: 'get'
		})
		.then(res => {
			if (res.status == "404") return {"0":{}};
			return res.json();
		})
		.then(json => {
			pJson = json;
			delete pJson["0"]; // Remove filler preset
			presetsLoaded = true;
			populatePresetSelects();
		})
		.catch((e) => {
			console.log("Error loading presets:", e);
			presetsLoaded = true; // Continue even if presets fail to load
		});
	}

	function populatePresetSelects() {
		// Update any existing preset select elements
		var selects = d.querySelectorAll('select.preset-select');
		selects.forEach(sel => {
			updatePresetSelect(sel, sel.dataset.value || sel.value || 0);
		});
	}

	function updatePresetSelect(selectElement, currentValue) {
		currentValue = parseInt(currentValue) || 0;
		selectElement.innerHTML = '<option value="0">Disabled</option>';

		// Sort presets by ID
		var presetIds = Object.keys(pJson).map(Number).sort((a,b) => a-b);

		for (var id of presetIds) {
			if (id > 0 && id <= 250) {
				var name = pJson[id].n || ("Preset " + id);
				var option = document.createElement('option');
				option.value = id;
				option.textContent = id + ": " + name;
				if (id == currentValue) option.selected = true;
				selectElement.appendChild(option);
			}
		}
	}
	function expand(o,i)
	{
		var t = gId("WD"+i);
		var isHidden = t.classList.contains('timer-details');
		if (isHidden) {
			t.classList.remove('timer-details');
			o.innerHTML = "&#x2715;";
		} else {
			t.classList.add('timer-details');
			o.innerHTML = "&#128197;";
		}
	}
	function Cs() { gId("cac").style.display=(gN("OL").checked)?"block":"none"; }
	var timerCount = 0; // Track number of timers
	var maxTimers = 64; // Default, will be overridden by server

	function BTa()
	{
		var ih = '<thead><tr><th><abbr title="Enabled">En.</abbr></th><th title="Type can be Sunrise, Sunset, or Regular">Type/Hour</th><th>Minute</th><th>Preset</th><th></th><th title="Timers are processed in order from top to bottom. If multiple timers trigger at the same time, the last one wins.">Order</th><th>Delete</th></tr></thead><tbody id="timerRows"></tbody>';
		gId("TMT").innerHTML = ih;
	}

	function addTimerRow(hour, minute, preset, weekdays, monthStart, dayStart, monthEnd, dayEnd) {
		// Check if we've reached the maximum number of timers
		if (timerCount >= maxTimers) {
			alert("Maximum number of timers (" + maxTimers + ") reached!\n\nPlease save your changes first to remove any deleted timers, then you may be able to add more.");
			return;
		}

		var i = timerCount++;
		var tbody = gId("timerRows");

		// Determine if this is sunrise/sunset or regular timer
		var isSunrise = (hour === 255);
		var isSunset = (hour === 254);
		var isSpecial = isSunrise || isSunset;

		// Default values
		if (hour === undefined) hour = 0;
		if (minute === undefined) minute = 0;
		if (preset === undefined) preset = 0;
		if (weekdays === undefined) weekdays = 255; // all days enabled by default
		if (monthStart === undefined) monthStart = 1;
		if (dayStart === undefined) dayStart = 1;
		if (monthEnd === undefined) monthEnd = 12;
		if (dayEnd === undefined) dayEnd = 31;

		var enabled = weekdays & 1;
		var dow = weekdays >> 1;

		// Create main row
		var tr = document.createElement('tr');
		tr.id = `timer${i}`;

		// Enabled checkbox
		var td = document.createElement('td');
		td.innerHTML = `<input name="W${i}" id="W${i}" type="hidden" value="${weekdays}"><input id="W${i}0" type="checkbox" ${enabled?'checked':''}>`;
		tr.appendChild(td);

		// Hour/Type selector (Regular hour or Sunrise/Sunset type)
		td = document.createElement('td');
		var hourInputClass = isSpecial ? 'xs timer-hour-input-hidden' : 'xs';
		td.innerHTML = `<select id="H${i}_sel" class="s" title="Timer type" onchange="updateTimerType(${i})">
			<option value="0" ${!isSpecial?'selected':''}>Regular</option>
			<option value="255" ${isSunrise?'selected':''}>Sunrise</option>
			<option value="254" ${isSunset?'selected':''}>Sunset</option>
		</select><input name="H${i}" id="H${i}" class="${hourInputClass}" type="number" min="0" max="24" value="${isSpecial?0:hour}" title="Hour (0-24)">`;
		tr.appendChild(td);

		// Minute / offset
		td = document.createElement('td');
		var minLabel = isSpecial ? 'Offset in minutes (-120 to 120)' : 'Minute (0-59)';
		var minRange = isSpecial ? 'min="-120" max="120"' : 'min="0" max="59"';
		td.innerHTML = `<input name="N${i}" id="N${i}" class="xs" type="number" ${minRange} value="${minute}" title="${minLabel}">`;
		tr.appendChild(td);

		// Preset
		td = document.createElement('td');
		td.innerHTML = `<select name="T${i}" id="T${i}" class="s preset-select" data-value="${preset}" title="Preset"></select>`;
		tr.appendChild(td);

		// Populate preset select if presets are loaded
		if (presetsLoaded) {
			var sel = gId(`T${i}`);
			if (sel) updatePresetSelect(sel, preset);
		}

		// Expand button
		td = document.createElement('td');
		td.innerHTML = `<div id="CB${i}" onclick="expand(this,${i})" class="cal">&#128197;</div>`;
		tr.appendChild(td);

		// Reorder buttons
		td = document.createElement('td');
		td.innerHTML = `<button type="button" class="timer-reorder-btn" onclick="moveTimerUp(${i})" title="Move up">&#x25B2;</button><button type="button" class="timer-reorder-btn" onclick="moveTimerDown(${i})" title="Move down">&#x25BC;</button>`;
		tr.appendChild(td);

		// Delete button
		td = document.createElement('td');
		td.innerHTML = `<button type="button" class="timer-delete-btn" onclick="removeTimerRow(${i})">&#x2715;</button>`;
		tr.appendChild(td);

		tbody.appendChild(tr);

		// Create details row
		tr = document.createElement('tr');
		var detailsHtml = `<div id="WD${i}" class="timer-details"><hr>Run on weekdays`;
		detailsHtml += `<table><tr><th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th></tr><tr>`;
		for (j=1;j<8;j++) {
			var checked = (dow >> (j-1)) & 1 ? 'checked' : '';
			detailsHtml += `<td><input id="W${i}${j}" type="checkbox" ${checked}></td>`;
		}
		detailsHtml += `</tr></table>`;

		// Date range (only for regular timers)
		var dateRangeClass = isSpecial ? 'timer-daterange-hidden' : '';
		detailsHtml += `<div id="dateRange${i}" class="${dateRangeClass}">from <select name="M${i}">`;
		for (j=0;j<12;j++) detailsHtml += `<option value="${j+1}" ${monthStart==j+1?'selected':''}>${ms[j]}</option>`;
		detailsHtml += `</select><input name="D${i}" class="xs" type="number" min="1" max="31" value="${dayStart}"> to <select name="P${i}">`;
		for (j=0;j<12;j++) detailsHtml += `<option value="${j+1}" ${monthEnd==j+1?'selected':''}>${ms[j]}</option>`;
		detailsHtml += `</select><input name="E${i}" class="xs" type="number" min="1" max="31" value="${dayEnd}"></div>`;
		detailsHtml += `<hr></div>`;

		td = document.createElement('td');
		td.colSpan = 7;
		td.innerHTML = detailsHtml;
		tr.appendChild(td);
		tbody.appendChild(tr);
	}

	function updateTimerType(i) {
		var hourSelect = gId(`H${i}_sel`);
		var hourInput = gId(`H${i}`);
		var minuteInput = gId(`N${i}`);
		var dateRange = gId(`dateRange${i}`);
		var isSpecial = (hourSelect.value == 254 || hourSelect.value == 255);

		if (hourInput) {
			if (isSpecial) {
				hourInput.classList.add('timer-hour-input-hidden');
			} else {
				hourInput.classList.remove('timer-hour-input-hidden');
			}
		}
		if (dateRange) {
			if (isSpecial) {
				dateRange.classList.add('timer-daterange-hidden');
			} else {
				dateRange.classList.remove('timer-daterange-hidden');
			}
		}

		// Update minute range
		if (isSpecial) {
			minuteInput.min = -120;
			minuteInput.max = 120;
			minuteInput.title = "Offset";
		} else {
			minuteInput.min = 0;
			minuteInput.max = 59;
			minuteInput.title = "";
		}
	}

	function removeTimerRow(i) {
		// Confirmation dialog
		if (!confirm("Are you sure you want to delete this timer?")) {
			return;
		}

		var row1 = gId(`timer${i}`);
		var row2 = row1 ? row1.nextElementSibling : null;

		// Mark fields as empty so backend deletes this timer
		var preset = gId(`T${i}`);
		var hour = gId(`H${i}`);
		var minute = gId(`N${i}`);
		var wField = gId(`W${i}`);

		if (preset) preset.value = 0;
		if (hour)   hour.value = 0;
		if (minute) minute.value = 0;
		if (wField) wField.value = 0;

		// Clear weekday checkboxes
		for (var j = 0; j < 8; j++) {
			var cb = gId(`W${i}${j}`);
			if (cb) cb.checked = false;
		}

		// Add visual indicator for deleted timer (red background + opacity)
		if (row1) {
			row1.classList.add('timer-deleted', 'timer-deleted-main');
		}
		if (row2) {
			row2.classList.add('timer-deleted');
		}

		// Decrement timerCount to allow adding new timers (ensure it doesn't go below zero)
		if (timerCount > 0) {
			timerCount--;
		}
	}

	function moveTimerUp(i) {
		var tbody = gId("timerRows");
		var row1 = gId(`timer${i}`);
		var row2 = row1 ? row1.nextElementSibling : null;

		if (!row1 || !row2) return;

		// Get previous timer rows (2 rows per timer: main + details)
		var prevRow2 = row1.previousElementSibling;
		if (!prevRow2) return; // Already at top
		var prevRow1 = prevRow2.previousElementSibling;
		if (!prevRow1) return;

		// Move current timer above previous timer
		tbody.insertBefore(row1, prevRow1);
		tbody.insertBefore(row2, prevRow1);
	}

	function moveTimerDown(i) {
		var tbody = gId("timerRows");
		var row1 = gId(`timer${i}`);
		var row2 = row1 ? row1.nextElementSibling : null;

		if (!row1 || !row2) return;

		// Get next timer rows (2 rows per timer: main + details)
		var nextRow1 = row2.nextElementSibling;
		if (!nextRow1) return; // Already at bottom
		var nextRow2 = nextRow1.nextElementSibling;
		if (!nextRow2) return;

		// Move current timer below next timer
		tbody.insertBefore(nextRow1, row1);
		tbody.insertBefore(nextRow2, row1);
	}

	function FC()
	{
		// This is called after settings are loaded to populate the UI
		// Server will call addTimerRow() directly via GetV() (see xml.cpp)
	}

	function Wd()
	{
		// Update weekday hidden fields from checkboxes before form submit
		var tbody = gId("timerRows");
		var rows = tbody.querySelectorAll('tr[id^="timer"]');
		var newIndex = 0;

		for (i=0; i<rows.length; i++) {
			var timerId = rows[i].id.replace('timer', '');

			// Skip deleted timers
			if (rows[i].classList.contains('timer-deleted')) continue;

			var wField = gId("W"+timerId);
			var hourSelect = gId("H"+timerId+"_sel");
			var hourInput = gId("H"+timerId);

			// Update weekday hidden field from checkboxes
			if (wField) {
				var m = 1;
				var val = 0;
				for (var j = 0; j < 8; j++) {
					var cb = gId("W"+timerId+j);
					if (cb) val += cb.checked * m;
					m *= 2;
				}
				wField.value = val;
			}

			// Update hour field based on timer type
			if (hourSelect && hourInput) {
				if (hourSelect.value == 0) {
					// Regular timer - use the hour input value
				} else {
					// Sunrise/sunset - use select value
					hourInput.value = hourSelect.value;
				}
			}

			// Rename all form fields to use the new sequential index
			// This ensures backend receives timers in DOM order
			var fieldsToRename = [
				{old: "W" + timerId, new: "W" + newIndex},
				{old: "H" + timerId, new: "H" + newIndex},
				{old: "N" + timerId, new: "N" + newIndex},
				{old: "T" + timerId, new: "T" + newIndex},
				{old: "M" + timerId, new: "M" + newIndex},
				{old: "D" + timerId, new: "D" + newIndex},
				{old: "P" + timerId, new: "P" + newIndex},
				{old: "E" + timerId, new: "E" + newIndex}
			];

			for (var k = 0; k < fieldsToRename.length; k++) {
				var field = gId(fieldsToRename[k].old);
				if (field) {
					field.name = fieldsToRename[k].new;
				}
			}

			newIndex++;
		}

		if (d.Sf.LTR.value==="S") { d.Sf.LT.value = -1*parseFloat(d.Sf.LT.value); }
		if (d.Sf.LNR.value==="W") { d.Sf.LN.value = -1*parseFloat(d.Sf.LN.value); }
	}
	function addRow(i,p,l,d) {
		var t = gId("macros");	// table
		var rCnt = t.rows.length;   // get the number of rows.
		var tr = t.insertRow(rCnt); // table row.
		var b = String.fromCharCode((i<10?48:55)+i);
		var td = document.createElement('td');          // TABLE DEFINITION.
		td = tr.insertCell(0);
		td.innerHTML = `Button ${i}:`;
		td = tr.insertCell(1);
		td.innerHTML = `<select name="MP${b}" id="MP${b}" class="s preset-select" data-value="${p}" required></select>`;
		td = tr.insertCell(2);
		td.innerHTML = `<select name="ML${b}" id="ML${b}" class="s preset-select" data-value="${l}" required></select>`;
		td = tr.insertCell(3);
		td.innerHTML = `<select name="MD${b}" id="MD${b}" class="s preset-select" data-value="${d}" required></select>`;

		// Populate preset selects if presets are loaded
		if (presetsLoaded) {
			var selP = gId(`MP${b}`);
			var selL = gId(`ML${b}`);
			var selD = gId(`MD${b}`);
			if (selP) updatePresetSelect(selP, p);
			if (selL) updatePresetSelect(selL, l);
			if (selD) updatePresetSelect(selD, d);
		}
	}
	function getLatLon() {
		if (!el) {
			window.addEventListener("message", (event) => {
				if (event.origin !== "https://locate.wled.me") return;
				if (event.data instanceof Object) {
					d.Sf.LT.value = event.data.lat;
					d.Sf.LN.value = event.data.lon;
					updLatLon();
				}
			}, false);
			el = true;
		}
		window.open("https://locate.wled.me","_blank");
	}
	function updLatLon(i) {
		if (parseFloat(d.Sf.LT.value)<0) { d.Sf.LTR.value = "S"; d.Sf.LT.value = -1*parseFloat(d.Sf.LT.value); } else d.Sf.LTR.value = "N";
		if (parseFloat(d.Sf.LN.value)<0) { d.Sf.LNR.value = "W"; d.Sf.LN.value = -1*parseFloat(d.Sf.LN.value); } else d.Sf.LNR.value = "E";
	}
	</script>
	<style>
		@import url("style.css");
		.timer-deleted {
			background-color: rgba(200, 0, 0, 0.2);
			opacity: 0.6;
		}
		.timer-deleted-main {
			text-decoration: line-through;
		}
		.timer-reorder-btn {
			background: var(--c-3);
			color: var(--c-f);
			padding: 2px 6px;
		}
		.timer-delete-btn {
			background: var(--c-6);
			color: var(--c-f);
		}
		.timer-hour-input-hidden {
			display: none;
		}
		.timer-details {
			display: none;
			background-color: #444;
		}
		.timer-daterange-hidden {
			display: none;
		}
		.timer-add-btn {
			margin-top: 10px;
		}
		/* Add question mark indicator to table headers with titles */
		#TMT thead th[title]::after {
			content: " ?";
			font-size: 0.8em;
			opacity: 0.6;
			cursor: help;
		}
	</style>
</head>
<body onload="S()">
	<form id="form_s" name="Sf" method="post" onsubmit="Wd()">
		<div class="toprow">
		<div class="helpB"><button type="button" onclick="H('features/settings/#time-settings')">?</button></div>
		<button type="button" onclick="B()">Back</button><button type="submit">Save</button><hr>
		</div>
		<h2>Time setup</h2>
		Get time from NTP server: <input type="checkbox" name="NT"><br>
		<input type="text" name="NS" maxlength="32"><br>
		Use 24h format: <input type="checkbox" name="CF"><br>
		Time zone: 
		<select name="TZ">
			<option value="0" selected>GMT(UTC)</option>
			<option value="1">GMT/BST</option>
			<option value="2">CET/CEST</option>
			<option value="3">EET/EEST</option>
			<option value="4">US-EST/EDT</option>
			<option value="5">US-CST/CDT</option>
			<option value="6">US-MST/MDT</option>
			<option value="7">US-AZ</option>
			<option value="8">US-PST/PDT</option>
			<option value="9">CST (AWST, PHST)</option>
			<option value="10">JST (KST)</option>
			<option value="11">AEST/AEDT</option>
			<option value="12">NZST/NZDT</option>
			<option value="13">North Korea</option>
			<option value="14">IST (India)</option>
			<option value="15">CA-Saskatchewan</option>
			<option value="16">ACST</option>
			<option value="17">ACST/ACDT</option>
			<option value="18">HST (Hawaii)</option>
			<option value="19">NOVT (Novosibirsk)</option>
			<option value="20">AKST/AKDT (Anchorage)</option>
			<option value="21">MX-CST</option>
			<option value="22">PKT (Pakistan)</option>
			<option value="23">BRT (Bras√≠lia)</option>
		</select><br>
		UTC offset: <input name="UO" type="number" min="-65500" max="65500" required> seconds (max. 18 hours)<br>
		Current local time is <span class="times">unknown</span>.<br>
		Latitude: <select name="LTR"><option value="N">N</option><option value="S">S</option></select><input name="LT" type="number" class="xl" min="0" max="66.6" step="0.01"><br>
		Longitude: <select name="LNR"><option value="E">E</option><option value="W">W</option></select><input name="LN" type="number" class="xl" min="0" max="180" step="0.01"><br>
		<button type="button" id="locbtn" onclick="getLatLon()">Get location</button>
		<div><i>(opens new tab, only works in browser)</i></div>
		<div id="sun" class="times"></div>
		<h3>Clock</h3>
		Analog Clock overlay: <input type="checkbox" name="OL" onchange="Cs()"><br>
		<div id="cac">
			First LED: <input name="O1" type="number" min="0" max="1024" required> Last LED: <input name="O2" type="number" min="0" max="1024" required><br>
			12h LED: <input name="OM" type="number" min="0" max="1024" required><br>
			Show 5min marks: <input type="checkbox" name="O5"><br>
			Seconds (as trail): <input type="checkbox" name="OS"><br>
			Show clock overlay only if all LEDs are solid black: <input type="checkbox" name="OB"><br>
		</div>
		Countdown Mode: <input type="checkbox" name="CE"><br>
		Countdown Goal:<br>
		Date:&nbsp;<nowrap>20<input name="CY" class="xs" type="number" min="0" max="99" required>-<input name="CI" class="xs" type="number" min="1" max="12" required>-<input name="CD" class="xs" type="number" min="1" max="31" required></nowrap><br>
		Time:&nbsp;<nowrap><input name="CH" class="xs" type="number" min="0" max="23" required>:<input name="CM" class="xs" type="number" min="0" max="59" required>:<input name="CS" class="xs" type="number" min="0" max="59" required></nowrap><br>
		<h3>Macro presets</h3>
		<b>Macros have moved!</b><br>
		<i>Presets now also can be used as macros to save both JSON and HTTP API commands.<br>
		Just select the preset below!</i>
		<i>Use "Disabled" for the default action instead of a preset</i><br>
		Alexa On Preset: <select name="A0" class="m preset-select" data-value="0" required></select><br>
		Alexa Off Preset: <select name="A1" class="m preset-select" data-value="0" required></select><br>
		Countdown-Over Preset: <select name="MC" class="m preset-select" data-value="0" required></select><br>
		Timed-Light-Over Preset: <select name="MN" class="m preset-select" data-value="0" required></select><br>
		<h3>Button actions</h3>
		<table style="margin: 0 auto;" id="macros">
			<thead>
				<tr>
					<td>push<br>switch</td>
					<td>short<br>on-&gt;off</td>
					<td>long<br>off-&gt;on</td>
					<td>double<br>N/A</td>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		<a href="https://kno.wled.ge/features/macros/#analog-button" target="_blank">Analog Button setup</a>
		<h3>Time-controlled presets</h3>
		<div style="display: inline-block">
		<table id="TMT" style="min-width:330px;"></table>
		<button type="button" class="timer-add-btn" onclick="addTimerRow()">+ Add Timer</button>
		</div>
		<p><b>Type/Hour</b>: Select "Regular" and enter hour (0-24), or select "Sunrise"/"Sunset" for sun-based timers.<br>
		<b>Minute</b>: For regular timers (0-59), for sunrise/sunset use offset in minutes (-120 to 120). e.g.- 60 is 1 hour <i>after</i> Sunset<br></p>
		<hr>
		<button type="button" onclick="B()">Back</button><button type="submit">Save</button>
	</form>
</body>
</html>
