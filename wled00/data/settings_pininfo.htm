<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<title>Pin Info</title>
	<script src="common.js" type="text/javascript"></script>
	<script>
		pinsTimer=null, gpioInfo={};
		function S() {
			getLoc();
			loadJS(getURL('/settings/s.js?p=11'), false, ()=>{
				d.um_p = [];
				d.rsvd = [];
				d.ro_gpio = [];
				d.max_gpio = 50;
				d.touch = [];
			}, ()=>{
				// Load extended GPIO info and start pin polling
				loadPins();
				pinsTimer = setInterval(loadPins, 250);
			});
			if (loc) d.Sf.action = getURL('/settings/pins');
		}

		function B(){window.open(getURL('/settings'),'_self');} // back button

		function getOwnerName(o,t,n){
			// Use firmware-provided name if available, otherwise fall back to ID-based lookup
			if(n) return n;
			if(!o) return "System";
			if(o&0x80){
				switch(o){
					case 0x81: return "Ethernet";
					case 0x82: return "LED Digital";
					case 0x83: return "LED On/Off";
					case 0x84: return "LED PWM";
					case 0x85: return getBtnTypeName(t);
					case 0x86: return "IR Receiver";
					case 0x87: return "Relay";
					case 0x88: return "SPI RAM";
					case 0x89: return "Debug";
					case 0x8A: return "DMX Output";
					case 0x8B: return "I2C";
					case 0x8C: return "SPI";
					case 0x8D: return "DMX Input";
					case 0x8E: return "HUB75";
				}
			}
			return "UM #"+o;
		}
		function getBtnTypeName(t){
			var n=["None","Reserved","Push","Push Inv","Switch","PIR","Touch","Analog","Analog Inv","Touch Switch"];
			var label = n[t] || "?";
			return 'Button <span style="font-size:10px;color:#888">'+label+'</span>';
		}
		function getCaps(p,c){
			var r=[];
			// Use touch info from settings endpoint
			if(d.touch && d.touch.includes(p)) r.push("Touch");
			// Use other caps from JSON (Analog, Boot, Input Only)
			if(c&0x02) r.push("Analog");
			if(c&0x08) r.push("Flash Boot");
			if(c&0x10) r.push("Bootstrap");
			if(c&0x20) r.push("Input Only");
			return r.length?r.join(", "):"-";
		}
		function loadPins(){
			fetch(getURL('/json/pins'),{method:'get'})
			.then(r=>r.json())
			.then(j=>{
				var cn="",pins=j.pins||[];
				if(!pins.length){
					cn="No pins available.";
				}else{
					cn='<table><tr><th>Pin</th><th>Used by</th><th>Specialities</th></tr>';
					for(var p of pins){
						var st=""; // button state indicator
						var tv=""; // touch value
						if(typeof p.s!=='undefined'){
							st='<span class="ps" style="background:'+(p.s?'#0B4':'#666')+'"></span> '; // button state, gray=off, green=on
							// Add raw touch reading if available
							if(typeof p.r!=='undefined')tv=' <span style="font-size:10px;color:#888">'+p.r+'</span>';
						}
						// Determine owner name using firmware name or fallback to UI lookup
						var ow=p.a?getOwnerName(p.o, p.t, p.n):(d.um_p && d.um_p.includes(p.p)) ? "Usermod":'<span style="color:#08d">Available</span>';
						//if(typeof p.u!=='undefined')ow+=p.u?' (PU)':' (No PU)';
						cn+='<tr><td>GPIO'+p.p+'</td><td>'+st+ow+tv+'<td>'+getCaps(p.p,p.c||0)+'</td></tr>';
					}
					cn+='</table>';
				}
				gId('pins').innerHTML=cn;
			})
			.catch(e=>{gId('pins').innerHTML='Error loading pin info';});
		}
	</script>
	<style>
		@import url("style.css");
		body{text-align:center;background:#222;margin:auto;padding:10px;max-width: 550px}
		table{width:100%;border-collapse:collapse;margin:10px 0;font-size:14px;border-radius:6px;overflow:hidden;}
		th,td{padding:8px;border:3px solid #444;color:#fff}
		th{background:#444}
		tr:nth-child(even){background:#222}
		tr:nth-child(odd){background:#111}
		.ps{display:inline-block;width:14px;height:14px;border-radius:50%}
	</style>
</head>
<body onload="S()">
	<h2>Pin Info</h2>
	<div id="pins">Loading...</div>
	<button type="button" onclick="B()">Back</button>
</body>
</html>
