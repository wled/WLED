<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport">
	<title>Pin Info</title>
	<script src="common.js" type="text/javascript"></script>
	<script>
		pinsTimer=null, gpioInfo={};
		function S() {
			getLoc();
			loadJS(getURL('/settings/s.js?p=11'), false, ()=>{
				d.um_p = [];
				d.rsvd = [];
				d.ro_gpio = [];
				d.max_gpio = 50;
				d.touch = [];
			}, ()=>{
				// Load extended GPIO info and start pin polling
				loadPins();
				pinsTimer = setInterval(loadPins, 250);
			});
			if (loc) d.Sf.action = getURL('/settings/pins');
		}

		function B(){window.open(getURL('/settings'),'_self');} // back button

		function getOwnerName(o,t,n){
			// Owner name is now provided by the firmware
			return n || "Unknown";
		}
		function getBtnTypeName(t){
			// Button type name is now included in owner name from firmware
			return "";
		}
		function getCaps(p,c){
			var r=[];
			// Use touch info from settings endpoint
			if(d.touch && d.touch.includes(p)) r.push("Touch");
			// Use other caps from JSON (Analog, Boot, Input Only)
			if(c&0x02) r.push("Analog");
			if(c&0x08) r.push("Flash Boot");
			if(c&0x10) r.push("Bootstrap");
			if(c&0x20) r.push("Input Only");
			return r.length?r.join(", "):"-";
		}
		function loadPins(){
			fetch(getURL('/json/pins'),{method:'get'})
			.then(r=>r.json())
			.then(j=>{
				var cn="",pins=j.pins||[];
				if(!pins.length){
					cn="No pins available.";
				}else{
					cn='<table><tr><th>Pin</th><th>Used by</th><th>Specialities</th></tr>';
					for(var p of pins){
						var st=""; // button state indicator
						var tv=""; // touch value
						if(typeof p.s!=='undefined'){
							st='<span class="ps" style="background:'+(p.s?'#0B4':'#666')+'"></span> '; // button state, gray=off, green=on
							// Add raw touch reading if available
							if(typeof p.r!=='undefined')tv=' <span style="font-size:10px;color:#888">'+p.r+'</span>';
						}
						// Determine owner name - firmware now provides it as 'n' field
						var ow=p.a?(p.n||'Unknown'):(d.um_p && d.um_p.includes(p.p)) ? "Usermod":'<span style="color:#08d">Available</span>';
						//if(typeof p.u!=='undefined')ow+=p.u?' (PU)':' (No PU)';
						cn+='<tr><td>GPIO'+p.p+'</td><td>'+st+ow+tv+'<td>'+getCaps(p.p,p.c||0)+'</td></tr>';
					}
					cn+='</table>';
				}
				gId('pins').innerHTML=cn;
			})
			.catch(e=>{gId('pins').innerHTML='Error loading pin info';});
		}
	</script>
	<style>
		@import url("style.css");
		body{text-align:center;background:#222;margin:auto;padding:10px;max-width: 550px}
		table{width:100%;border-collapse:collapse;margin:10px 0;font-size:14px;border-radius:6px;overflow:hidden;}
		th,td{padding:8px;border:3px solid #444;color:#fff}
		th{background:#444}
		tr:nth-child(even){background:#222}
		tr:nth-child(odd){background:#111}
		.ps{display:inline-block;width:14px;height:14px;border-radius:50%}
	</style>
</head>
<body onload="S()">
	<h2>Pin Info</h2>
	<div id="pins">Loading...</div>
	<button type="button" onclick="B()">Back</button>
</body>
</html>
